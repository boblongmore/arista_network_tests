---

- name: Retrieve int facts via graphql query
  ansible.builtin.uri:
    url: "{{ NETBOX_API }}/graphql/"
    validate_certs: false
    method: POST
    follow_redirects: all
    headers:
      Authorization: " Token {{ NETBOX_TOKEN }}"
      Accept: "application/json"
      Content-Type: application/json
    body_format: json

    body:
      query: "{{ lookup('template', '../templates/graph_int_list.j2') }}"
  register: graph_lookup
  tags: interfaces

- name: Gather network resources
  arista.eos.eos_facts:
    gather_subset:
      - interfaces
  register: network_resources
  tags: interfaces

- name: Set fact for the information we want from the running config
  ansible.builtin.set_fact:
    running_int: "{{ network_resources.ansible_facts.ansible_net_interfaces }}"

- name: Use assert module to compare outputs
  ansible.builtin.assert:
    that:
      - running_int[item.name]['operstatus'] == 'connected'
      - running_int[item.name]['ipv4']['address'] in item.ip_addresses[0]['address']
      - running_int[item.name]['ipv4']['masklen'] == item.ip_addresses[0]['address'] | ansible.builtin.ipaddr('prefix')
  loop: "{{ graph_lookup.json.data.interface_list }}"
  when: item.name != "Management1" and item.enabled == true
